---
title: "Second Draft Report: Ametop Study with Dr. Louis Scheepers"
output: pdf_document
date: "25 March 2024"
header-includes:
   - \usepackage{multirow}
   - \usepackage{float}
     \let\origfigure\figure
     \let\endorigfigure\endfigure
     \renewenvironment{figure}[1][2] {
     \expandafter\origfigure\expandafter[H]
     } {
      \endorigfigure
     }
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
# Set up echo as false to not print the R code in the report
library(knitr)
library(readxl)
library(ggplot2)
library(broom)
library(tidyverse)
library(gridExtra)
```

\begin{center}
Group 6

Fabiola Grace

Maggie Ruan

Runhe Guo

Yimin You

\end{center}

\newpage

# 1. Summary

This study aims to improve pain management for pediatric patients during intravenous (IV) insertions, a common yet distressing procedure. We investigated the effectiveness of two treatments: Ametop gel as a standalone treatment and the combination of Ametop and vapocoolant spray. A randomized controlled experiment was conducted to assess the pain levels of pediatric patients during IV insertions after receiving either Ametop gel alone or a combination of Ametop gel and vapocoolant spray. A two-sample t-test was used to compare changes in pain levels between the two treatment groups, and a linear regression was performed to examine the association between age and pain level. The result of the two-sample t-test indicates that adding vapocoolant spray significantly reduced the discomfort of IV insertions in pediatric patients. Moreover, the regression analysis revealed that younger children experienced more pain. The number of IV attempts and side effects were also evaluated, and the findings showed that adding vapocoolant spray did not increase the number of IV attempts. Overall, the results suggest that the combination of Ametop and vapocoolant spray is more effective than Ametop alone, particularly for younger children.

# 2. Introduction 

Intravenous (IV) insertion is an essential medical procedure that is frequently associated with discomfort and pain, particularly in pediatric patients. To mitigate this, BC Children's Hospital currently utilizes Ametop gel, a topical anesthetic that numbs the skin prior to needle insertion, to alleviate pain and ease the process. Despite its efficacy, Ametop gel alone may not suffice, especially in individuals with heightened sensitivity to pain. To provide better medical care for pediatric patients, the hospital is considering the additional use of a vapocoolant spray. This spray acts rapidly to cool and numb the skin and is hypothesized to provide better pain relief during IV insertions. 

To evaluate the effectiveness of adding a vapocoolant spray to Ametop gel, we formulated two research questions and conducted a corresponding statistical analysis. The questions are as follows:

- Does the addition of a vapocoolant spray to Ametop reduce pediatric discomfort during IV insertions more than Ametop alone?

- What is the relationship between patient age and randomization group (control vs. study) to their pain level?

Furthermore, we want to ensure that the use of vapocoolant spray does not increase the number of IV attempts and to assess the incidence of side effects among pediatric patients. The following sections detail the data description, statistical methods, and the results derived from our analysis.

# 3. Data description 
This study retrospectively collected data from 240 pediatric patients undergoing intravenous (IV) insertion. Some participants withdrew from the study for reasons such as itchiness from Ametop and conversion to inhalation induction. Due to inadequate data on pain levels for these instances, it was not feasible to address the missing information with imputation techniques or other methods. Consequently, we excluded these 17 observations, focusing solely on the remaining 223 observations for our research questions. The dataset has several key variables, categorized as follows:

- **Patient Demographics:** This includes variables such as age, gender, and ASA classification, which are crucial for subgroup analysis. Age (5-16 years old) is particularly important for determining if responses to pain management strategies vary among different pediatric age groups.
- **Randomization Groups:** Patients were randomly assigned to one of two groups: Group 1, receiving Ametop alone (the control group), and Group 2, receiving both Ametop and the vapocoolant spray (the study group). This randomization is essential for assessing the comparative effectiveness of the two treatment approaches.
- **FPS-R Scores:** Patientsâ€™ pain levels were rated using the Faces Pain Scales-Revised scale from 0 (no pain) to 10 (worst pain possible), offering a measurable discomfort level during IV insertion. This score determines the primary outcome, that is, the effectiveness of different treatment approaches.
- **Number of IV Attempts:** This variable represents the number of attempts needed for a successful IV insertion, reflecting the procedural difficulty and its potential correlation with patient discomfort.
- **Side Effects:** Side effects, including the appearance of redness, sensations of itchiness, puffiness, or pain, were recorded to check if participants experienced any severe adverse reactions to the treatment.

Other than these variables, there were nine controlled variables, encompassing specifications such as an age range of 5-16 years and whether the patient has a needle phobia, to guarantee that participants met a defined set of eligibility criteria.

# 4. Methods

In this analysis, we employ several statistical methods to address our research objectives. We use a two-sample T-test to assess the primary objective of comparing the difference in mean FPS-R scores between the control and study groups. For our first secondary objective, we perform a linear regression analysis to explore the relationship between age and randomization groups on FPS-R scores. To illustrate the second secondary objective, we present a bar graph depicting the number of IV attempts across the two groups. Lastly, we use a pie chart to display the distribution of side effects among all participants, addressing our third secondary objective.

\vspace{5mm}

**4.1 Main Objective: Does the Combination of Ametop with a Vapocoolant Spray Significantly Reduce the Discomfort Experienced by Pediatric Patients During IV Insertions, Compared to Using Ametop Alone?**

We begin with exploratory data analysis to examine the distribution of the target response variable, the FPS-R scores. Figure 1 displays comparative boxplots for the control and study groups, illustrating the distribution of these FPS-R scores.

\vspace{3mm}

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.height=1.5, fig.align='center', fig.cap = "FPS-R Scores Boxplots of Control (Ametop) and Study (Ametop + Spray) Group"}
# Read data
file_path <- "../data/Ametop-PE data(new-Alex)(1control 2study).xlsx"
original_data <- read_excel(file_path)

# Save original data for side effects analysis
data <- original_data

# Remove withdrawn patients
data <- data[data$`Withdrawn after consent?` != "Yes", ]

# Remove unnecessary variables
data <- select(data, 
               -`Elective surgery requiring IV?`,
               -`ASA I or II?`,
               -`Aged 5-16?`,
               -`Any allergies to Ametop, Pain Ease, or Tagederm adhesive?`,
               -`Ametop placed at least 30min before estimated IV start time?`,
               -`Receiving sedative pre-medication / anxiolytics?`,
               -`Needle phobia?`,
               -`Planned inhalation induction?`,
               -`Developmental delay or unable to interpret FPS-R?`,
               -`Time Ametop applied`,
               -`Time Ametop removed`,
               -`Time of skin puncture`,
               -`Record ID`,
               -`Complete?`,
               -`Withdrawn after consent?`,
               -`Reason for withdrawal`,
               -`Other reason for withdrawal`)

# Boxplots
plot1 <- data %>% filter(Randomization == 1) %>%
  ggplot(aes(`FPS-R score`, fill = "Control Group")) +
  geom_boxplot(alpha = 0.7) +
  labs(title = "Control Group FPS-R Scores Boxplot") +
  scale_fill_manual(values = c("Control Group" = "#219ebc")) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, size = 10, face = "bold"), legend.position = "none")

plot2 <- data %>% filter(Randomization == 2) %>%
  ggplot(aes(`FPS-R score`, fill = "Study Group")) +
  geom_boxplot(alpha = 0.7) +
  labs(title = "Study Group FPS-R Scores Boxplot") +
  scale_fill_manual(values = c("Study Group" = "#fb8500")) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, size = 10, face = "bold"), legend.position = "none")

grid.arrange(plot1, plot2, ncol = 2, nrow = 1)
```

From Figure 1, we observe that the median FPS-R score for both the control and study groups is 2. The study group displays a higher concentration of scores at FPS-R scores 0 and 2, resulting in a right-skewed distribution, and FPS-R scores 6 and above are considered outliers.

The two-sample T-Test is used to assess whether the addition of vapocoolant spray reduces discomfort. This test is applied under the assumption that the differences between the means of the control and study groups follow a Normal distribution. Although the dataset itself is not normally distributed, the sample size is large enough that, according to the Central Limit Theorem (CLT), we can still utilize the T-test. The null hypothesis asserts that the mean FPS-R scores for both groups are the same, while the alternative hypothesis is that the mean FPS-R score is lower for the study group that is using the vapocoolant spray. Consequently, we are employing a one-sided t-test and the significance threshold for the p-value is set at the 5% significance level.

**4.2 Secondary Objective 1: The Relationship between Age and Randomization (Control and Study) Groups on FPS-R Scores.**

Regarding the second statistical question concerning the impact of age and randomization (study and control) groups on FPS-R scores, we implement a linear regression analysis. This approach enables us to explore the relationship between age, the randomization group, and the combined effect of both age and the randomization group on the FPS-R scores. In constructing our model, we ensure that the assumptions underlying linear regression are satisfied. These assumptions include linearity, independence, homoscedasticity, and normality of residuals. The statistical significance of the model coefficients is assessed with a p-value threshold of 5% significance level.

**4.3 Secondary Objective 2: Does the Combination of Ametop with a Vapocoolant Spray Increase the Number of IV Insertion Attempts, Compared to Using Ametop Alone?**

To investigate whether the combination of Ametop with a vapocoolant spray increases the number of IV insertion attempts compared to the application of Ametop alone, we use summary statistics and visually analyze the data using plots. These help us understand the distribution and average number of IV attempts in both the control group (Ametop alone) and the study group (Ametop with vapocoolant spray).

We choose not to conduct statistical tests for this comparison to avoid multiple tests on the same dataset. This can reduce the statistical power of the tests and the probability of detecting the true effect of the study. When multiple tests are performed on the same dataset, the chances of finding significant results by chance increase, thereby reducing the confidence in the findings. Therefore, we rely on visual inspection of the data to draw preliminary conclusions about the impact of the combined treatment on the number of IV insertion attempts.

**4.4 Secondary Objective 3: The Incidence of Side Effects Due to Ametop by Pie Chart and Frequency Table.**

We begin with exploratory data analysis on all 240 participants of the study, including those who withdrew prior to the study's completion. This approach accounts for patients who withdrew due to experiencing side effects, thereby preserving all incidences of side effects in the dataset.

We then categorize the observed side effects into four distinct groups: "Redness," "Redness and Itching," "Puffiness," and "Pain" to facilitate the quantitative analysis of side effects. We present the findings in a pie chart and frequency table.

# 5. Result

In this section, we present the results of our data analysis. We compared the p-value to the significance level for the two-sample T-Test. Then, we examined a linear regression model on the response variable, using their estimates and p-values. The results are presented in Table 1, Table 2, Figure 2, Figure 3 and Figure 4. 

**5.1 Main Objective: Does the Combination of Ametop with a Vapocoolant Spray Significantly Reduce the Discomfort Experienced by Pediatric Patients During IV Insertions, Compared to Using Ametop Alone?**

For the main objective, we performed a two-sample T-test on the two randomization (control and study) groups and FPS-R scores. The results of the test, including the group means, standard error, and p-value, are shown in Table 1 below.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
table_data <- data.frame(
  `Control Group Mean` = 2.6909,
  `Study Group Mean` = 1.9292,
  `Standard Error` = 0.3779,
  `P-value` = 0.02258,
  check.names = FALSE
)

kable(table_data, caption = "Control Group and Study Group Two-Sample T-Test", format = "markdown")
```

The mean FPS-R score for the group with Ametop alone is 2.6909, while the mean FPS-R score for the group with the combination of Ametop and vapocoolant spray is 1.9292. The test yields a p-value of 0.02258, which is below the 5% significance threshold. This allows us to reject the null hypothesis at the 5% significance level, indicating a difference in the mean FPS-R scores between the control and study groups. These results support the hypothesis that adding vapocoolant spray may reduce discomfort in pediatric patients.

**5.2 Secondary Objective 1: The Relationship between Age and Randomization (Control and Study) Groups on FPS-R Scores.**

For our second statistical question, we built a linear regression model on age, randomization group, and the combined effect of both age and randomization group to find their relationship with the FPS-R scores. The results of the linear regression model are shown in Table 2 below.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
regression_table <- data.frame(
  Term = c("(Intercept)", "Age", "Study Group", "Age:Study Group"),
  Estimate = c(4.1459, -0.1640, -1.6818, 0.1098),
  `Standard Error` = c(0.7175, 0.0751, 1.0279, 0.1024),
  `P-value` = c("< .0001", "0.0301", "0.1032", "0.2847"),
  check.names = FALSE
)

kable(regression_table, caption = "Linear Regression Model Output", format = "markdown")
```

Our findings indicate that age is a significant factor in FPS-R scores, as suggested by the p-value in Table 2. The model estimates that with each additional year of age, the FPS-R scores decrease by an average of 0.164, suggesting that older children experience less pain during IV insertion.

Although the estimates for the randomization group and the interaction between age and the randomization group do not reach conventional levels of statistical significance, they still offer valuable insights. The model estimates that children in the study group, which involved the application of vapocoolant spray, are associated with a decrease of 1.6818 in the FPS-R scores. This matches our earlier findings in the main objective that imply that the use of vapocoolant spray is effective in reducing pain levels in IV insertions for children.

From the estimates in Table 2, we create a linear regression model that represents the average FPS-R scores among children according to their age and group allocation depicted in Figure 2.

```{r, echo=FALSE, message=FALSE, warning=FALSE, out.width="70%", fig.align='center', fig.cap='Linear Regression Model for Control and Study Group'}
# Plot the linear regression line
ggplot(data, aes(x = Age, y = `FPS-R score`, color = factor(Randomization))) +
  # Add the regression line
  geom_smooth(method = "lm", se = FALSE) +
  # Set plot labels
  xlab("Age") +
  ylab("FPS-R score") +
  labs(color = "Randomization", title = "Linear Regression Model for Control and Study Group") +
  scale_color_manual(values = c("#219ebc", "#fb8500"),
                     labels = c("Control Group", "Study Group")) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))
```

Examining Figure 2, it is observed that as age increases, the difference in the decrease in FPS-R scores between the study and control groups gets smaller. Notably, the two lines converge around the age of 15, suggesting that the efficacy of vapocoolant spray in reducing pain may not be as pronounced in children aged 15 and 16.

**5.3 Secondary Objective 2: Does the Combination of Ametop with a Vapocoolant Spray Increase the Number of IV Insertion Attempts, Compared to Using Ametop Alone?**

The figure below represents the number of IV insertion attempts in the control group compared to the study group with vapocoolant spray. 

```{r, echo=FALSE, message=FALSE, warning=FALSE, out.width="75%", fig.align='center', fig.cap = "Number of IV Attempts for Control and Study Group"}
# Bar Chart for IV attempts
bar <- data %>%
  mutate(Group = ifelse(Randomization == 1, "Control Group", "Study Group")) %>%
  ggplot(aes(x = `Number of IV attempts`, fill = Group)) +
  geom_bar(position = "dodge") +
  scale_fill_manual(values = c("Control Group" = "#219ebc", "Study Group" = "#fb8500")) +
  labs(title = "Number of IV Attempts for Control and Study Group", x = "Number of IV Attempts",
    y = "Count", fill = "Group"
  ) +
    theme(
    plot.title = element_text(hjust = 0.5, face = "bold")
  )

print(bar)
```

Upon examining Figure 3, the distribution of IV attempts, both groups exhibit comparable patterns, with the majority of instances in both groups having a single IV attempt. Quantitatively, the study group, with vapocoolant spray, shows an average of 1.08 IV attempts. This is marginally lower than the control group's average of 1.155 attempts, where only Ametop was applied. Such observations lead us to conclude that there is no increase in the number of IV attempts for the study group when the vapocoolant spray is added.

In summary, through the analysis of simple summary plots and calculation of mean attempts, it becomes evident that the introduction of the vapocoolant spray does not result in an elevated number of IV attempts when combined with Ametop. 

**5.4 Secondary Objective 3: The Incidence of Side Effects Due to Ametop.**

First, we want to know the proportions of patients experiencing side effects. Our findings indicate that there are 12 out of 240 patients from the dataset that experience side effects. This finding is shown in Figure 4 pie chart.

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.height=3.9, fig.align='center', fig.cap = "Proportion of Observed Side Effects"}
# Pie chart draw function with percentages
draw_pie_chart <- function(all_categories, title) {
  # Count the occurrences of each category
  category_counts <- table(all_categories)

  # Calculate the percentage for each category
  percentages <- round(category_counts / sum(category_counts) * 100, 1)

  # Create labels that include both the category name and the percentage
  labels <- paste(names(category_counts), " - ", percentages, "%", sep="")

  pie(category_counts,
      main = title,
      col = c("#219ebc", "#fb8500"),
      labels = labels,
      cex = 1.0)
}

# Summarize "Any side effects observed?" column
side_effects_observed_summary <- data.frame(original_data$`Any side effects observed?`)

# Create a pie chart for the observed side effects
draw_pie_chart(side_effects_observed_summary, "Observed Side Effects")
```

As illustrated in Figure 4, 95% of the patients experience no side effects, and 5% of patients experience side effects.

Then, we want to understand the type of side effects present. Table 3 below shows how we categorize the side effects based on the description given in the dataset. 

```{r, echo=FALSE, message=FALSE, warning=FALSE}
side_effects_data <- data.frame(
  `Side Effects Description` = c(
    "Slight redness of skin from ametop",
    "Some redness on skin, more than usual",
    "vey mild pink and pruritic skin.",
    "complained of pain on the spray.",
    "slightly puffy hands after ametop removal",
    "pink skin and very mild itching",
    "redness from ametop",
    "quite red & itchy skin from ametop. Underlying eczema.",
    "redness at ametop site. Not painful or pruritic.",
    "redness & raised area under ametop",
    "quite itchy from ametop. Redness.",
    "Slight redness from ametop. No pruritis."
  ),
  Category = c(
    "Redness",
    "Redness",
    "Redness + Itching",
    "Pain",
    "Puffiness",
    "Redness + Itching",
    "Redness",
    "Redness + Itching",
    "Redness",
    "Redness",
    "Redness + Itching",
    "Redness"
  ),
  check.names = FALSE
)

kable(side_effects_data, caption = "Side Effects Category")
```

The category described in Table 3 can further be summarized into the count of each category. Table 4 below shows the frequency of each side effect category.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
side_effects_data <- data.frame(
  Category = c("Pain", "Puffiness", "Redness only", "Redness + Itching"),
  Frequency = c("1", "1", "6", "4")
)

kable(side_effects_data, caption = "Frequency Table of Side Effects")
```

As shown in Table 3 and Table 4, the most common side effect reported for patients was redness, either alone or accompanied by itching.

# 6. Conclusion

The primary objective was to determine whether the addition of a vapocoolant spray significantly reduces the discomfort experienced by pediatric patients during IV insertions compared to using Ametop alone. The results suggest that the addition of a vapocoolant spray does indeed significantly reduce the level of pain felt by the participants. A limitation of our study was the omission of observer scores. During data collection, observer scores were also recorded, where a nurse observed and rated the patients' discomfort on a 3-point scale: 'none,' 'slight,' or 'severe.' This rating aimed to capture visible signs of discomfort or pain, ensuring a reliable pain assessment in children who might be playful or might not fully understand the FPS-R pictogram provided. However, after matching the FPS-R scores with the observer scores, only 164 out of 240 datasets remained. Analyzing this subset would have been very interesting, but the study was not designed to include enough participants to adequately power such an analysis. 

Regarding our secondary objective, which is to identify the relationship between age and randomization (study and control) groups on the FPS-R scores, we conclude that age significantly affects the FPS-R scores. This emphasizes the importance of considering pediatric patientsâ€™ age during the anesthesia procedure of IV insertions. The combination of Ametop and vapocoolant spray is more effective in reducing discomfort for younger children and might not be necessary for children aged 15 and above. A limitation observed in this regression method is that the data do not appear to be exactly normally distributed, as indicated by the QQ plot, which shows a heavy-tailed distribution. However, since the focus is on inference rather than prediction, and considering the Central Limit Theorem (CLT) assumption, we proceeded with the use of linear regression for our analysis.

Additionally, the advantages of incorporating vapocoolant spray alongside Ametop are supported by the evidence which indicates that the use of vapocoolant spray in conjunction with Ametop does not lead to an increase in the number of IV attempts. This conclusion is drawn from the observation of similar distributions and a slightly lower mean number of IV attempts in the study group compared to the control group. Consequently, the anesthetist department may use the combination of Ametop and vapocoolant spray without the concern of increasing the number of IV attempts.

In the analysis of the side effects of Ametop, 95% of the patients experience no side effects. Among the 5% that do report side effects, the most common side effect reported for patients was redness, either alone or accompanied by itching.

In conclusion, combining Ametop gel and vapocoolant spray benefits pediatric patients during IV insertions. The combination of Ametop and vapocoolant spray significantly reduces discomfort in pediatric patients, particularly for younger children. Furthermore, the addition of spray also did not increase the number of IV attempts. However, older children, aged 15 and above, may not require the addition of vapocoolant spray. Currently, 5% of patients experience side effects, which may indicate the need for another medical procedure for some individuals.

\newpage

# References
Rogers TL, Ostrow CL. The use of EMLA cream to decrease venipuncture pain in children. Journal of Pediatric Nursing. 2004 Feb 1;19(1):33-9.

\newpage

# Appendix

## For client

**Formula**

**Two-Sample T-Test**

Let $x_i$ be the value for one of the response variables in our sample. $x_1, x_2, ..., x_{223}$ are considered as IID sample of size n = 223.

> $H_0$: The mean FPS-R scores for the control and study groups are the same.

> $H_a$: The mean FPS-R score is lower for the study group which is using the vapocoolant spray.

$\bar{x}$ is the sample mean and is the estimate of the response variable, and the $s_x$ is the sample standard deviation.

The formula for the two-sample T-test is:

$$
t = \frac{\bar{X}_1 - \bar{X}_2}{\frac{s_x} {\sqrt{n}}}
$$

We calculated the result using a one-sided test in R, and it is displayed in Table 1.

**Linear Regression Model**

Our model to test the relationship between age and randomization (control and study) groups on FPS-R scores is as follows:

$$
Y = 4.1459 - 0.1640X_1 - 1.6818X_2 + 0.1098X_1*X_2 + \epsilon
$$

where $\epsilon$ follows $N(0, \sigma^2)$, Y = FPS-R scores, $X_1$ = Age, and

$$
X_2 = \left\{ \begin{array}{cc} 1 & \text{if the patient is in the study group} \\ 0 & \text{if the patient is in the control group} \end{array}\right.
$$

From the linear regression, we can get the estimated coefficient and the p-value through R-codes that are presented in Table 2. Using the equation, we can calculate fitted values, which are the predicted values of the FPS-R scores using the data that is used to create the model, to create Figure 2.

\newpage

## For mentor

### Data cleaning

```{r, echo=TRUE}
# Read data
file_path <- "../data/Ametop-PE data(new-Alex)(1control 2study).xlsx"
original_data <- read_excel(file_path)

# Save original data for side effects analysis
data <- original_data

# Remove withdrawn patients
data <- data[data$`Withdrawn after consent?` != "Yes", ]

# Remove unnecessary variables
data <- select(data, 
               -`Elective surgery requiring IV?`,
               -`ASA I or II?`,
               -`Aged 5-16?`,
               -`Any allergies to Ametop, Pain Ease, or Tagederm adhesive?`,
               -`Ametop placed at least 30min before estimated IV start time?`,
               -`Receiving sedative pre-medication / anxiolytics?`,
               -`Needle phobia?`,
               -`Planned inhalation induction?`,
               -`Developmental delay or unable to interpret FPS-R?`,
               -`Time Ametop applied`,
               -`Time Ametop removed`,
               -`Time of skin puncture`,
               -`Record ID`,
               -`Complete?`,
               -`Withdrawn after consent?`,
               -`Reason for withdrawal`,
               -`Other reason for withdrawal`)
```

```{r, echo=TRUE}
# Check for missing values in all columns except 'Notes' and 'Observed side effects'
missing_values_summary <- data %>%
  select(-Notes, -`Observed side effects`) %>%
  summarise_all(~sum(is.na(.)))

# No missing values found
print(missing_values_summary)
```

```{r, echo=TRUE}
# Shorten the data
data$`Reaction to skin puncture` <- gsub("^(Slight|Severe).*", "\\1 Pain",
                                         data$`Reaction to skin puncture`)

# Verify the changes
table(data$`Reaction to skin puncture`)
```

### Data preprocessing

```{r, echo=TRUE}
# Create new variables for the dataset

# Create 'Observer Number'
data$`Observer Number` <- case_when(
  data$`Reaction to skin puncture` == "None" ~ 1,
  data$`Reaction to skin puncture` == "Slight Pain" ~ 2,
  data$`Reaction to skin puncture` == "Severe Pain" ~ 3
)

# Create 'FPS-R Number'
data$`FPS-R Number` <- case_when(
  data$`FPS-R score` %in% c(0, 2) ~ 1,
  data$`FPS-R score` %in% c(4, 6) ~ 2,
  data$`FPS-R score` %in% c(8, 10) ~ 3
)

# Create 'Match Responses'
data$`Match Responses` <- ifelse(data$`Observer Number` == data$`FPS-R Number`, "Yes", "No")

# Create data subset for match data
data_subset <- data[data$`Match Responses` == 'Yes',]
```

```{r, echo=TRUE}
# Verify data
head(data)
```

### Main Objective

#### Boxplots

```{r, echo=TRUE, fig.align='center'}
# Boxplots
plot1 <- data %>% filter(Randomization == 1) %>%
  ggplot(aes(`FPS-R score`, fill = "Control Group")) +
  geom_boxplot(alpha = 0.7) +
  labs(title = "Control Group FPS-R Scores Boxplot") +
  scale_fill_manual(values = c("Control Group" = "#219ebc")) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"), legend.position = "none")

plot2 <- data %>% filter(Randomization == 2) %>%
  ggplot(aes(`FPS-R score`, fill = "Study Group")) +
  geom_boxplot(alpha = 0.7) +
  labs(title = "Study Group FPS-R Scores Boxplot") +
  scale_fill_manual(values = c("Study Group" = "#fb8500")) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"), legend.position = "none")

plot1
plot2
```

#### Table

```{r, echo=TRUE}
# Create a table to count matches
table <- table(data$`Observer Number`, data$`FPS-R Number`)

# Name the rows and columns to reflect the desired format
rownames(table) <- c("1", "2", "3")
colnames(table) <- c("1", "2", "3")

# Output the 3x3 table
cat("Contingency Table of FPS-R Number vs. Observer Number\n")
cat("Rows: FPS-R Number\n")
cat("Columns: Observer Number\n\n")
print(table)
```

#### T-tests

```{r, echo=TRUE}
# Perform t-test on full data
t_test_full <- t.test(data[data$Randomization == 2, ]$`FPS-R score`,
                      data[data$Randomization == 1, ]$`FPS-R score`,
                      alternative = c("less"))
print(t_test_full)

# Conclusion: We should only reject the null hypothesis based on the full dataset.
```

### Secondary Objective 1: Linear Regression of Age * Randomization Group

```{r, echo=TRUE, fig.align='center'}
lm_age <- lm(`FPS-R score` ~ Age * factor(Randomization), data = data)
tidy(summary(lm_age))
plot(lm_age)
```

```{r, echo=TRUE, fig.align='center'}
# Plot the linear regression line
ggplot(data, aes(x = Age, y = `FPS-R score`, color = factor(Randomization))) +
  # Add the regression line
  geom_smooth(method = "lm", se = FALSE) +
  # Set plot labels
  xlab("Age") +
  ylab("FPS-R score") +
  labs(color = "Randomization", title = "Linear Regression Model for Control and Study Group") +
  scale_color_manual(values = c("#219ebc", "#fb8500"),
                     labels = c("Control Group", "Study Group")) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))
```

### Secondary Objective 2: Number of IV Attempts Analysis

```{r, echo=TRUE, fig.align='center'}
# Summary statistics
data_control <- data[data$`Randomization` == 1,]
data_study <- data[data$`Randomization` == 2,]
summary(data_control$`Number of IV attempts`)
summary(data_study$`Number of IV attempts`)

# Mean for study group decreases instead

# Bar Chart for IV attempts
bar <- data %>%
  mutate(Group = ifelse(Randomization == 1, "Control Group", "Study Group")) %>%
  ggplot(aes(x = `Number of IV attempts`, fill = Group)) +
  geom_bar(position = "dodge") +
  scale_fill_manual(values = c("Control Group" = "#219ebc", "Study Group" = "#fb8500")) +
  labs(title = "Number of IV Attempts for Control and Study Group", x = "Number of IV Attempts",
    y = "Count", fill = "Group"
  ) +
    theme(
    plot.title = element_text(hjust = 0.5, face = "bold")
  )

print(bar)

# No need further testing, from EDA we can see that the study group 
# didn't increase number of IV attempts (in fact, it decreases)
# (note: we did try doing t-test for confirmation and we can't reject null)
```

### Secondary Objective 3: Side Effects

#### Pie chart for Observed side effects

```{r, echo=TRUE, fig.align='center'}
# Pie chart draw function with percentages
draw_pie_chart <- function(all_categories, title) {
  # Count the occurrences of each category
  category_counts <- table(all_categories)

  # Calculate the percentage for each category
  percentages <- round(category_counts / sum(category_counts) * 100, 1)

  # Create labels that include both the category name and the percentage
  labels <- paste(names(category_counts), " - ", percentages, "%", sep="")
  
  pie(category_counts,
      main = title,
      col = c("#219ebc", "#fb8500"),
      labels = labels,
      cex = 1.0)
}

# Summarize "Any side effects observed?" column
side_effects_observed_summary <- data.frame(original_data$`Any side effects observed?`)

# Create a pie chart for the observed side effects
draw_pie_chart(side_effects_observed_summary, "Observed Side Effects")
```

```{r, echo=TRUE}
# Define the categorization function
categorize_effects <- function(effect) {
  effect_lower <- tolower(effect)
  categories <- list(
    Redness = "red|redness|pink",
    Itching = "itchy|pruritic|pruritis|itching",
    Pain = "pain|painful",
    Puffiness = "puffy"
  )

  identified_categories <- character(0)

  # Negation patterns
  pattern_start <- "\\b(no|not)\\s+("
  pattern_middle <- ")\\b|(no|not)\\s+\\w+\\s+or\\s+("
  pattern_end <- ")"

  for (category_name in names(categories)) {
    symptom_pattern <- categories[[category_name]]

    # Check for the symptom but exclude if negated
    if (grepl(symptom_pattern, effect_lower)) {
      negation_pattern <- paste0(
        pattern_start, symptom_pattern, pattern_middle, symptom_pattern, pattern_end)
      if (!grepl(negation_pattern, effect_lower)) {
        identified_categories <- c(identified_categories, category_name)
      }
    }
  }

  # Return "Other" if no category is found
  if (length(identified_categories) == 0) {
    return("Other")
  }

  return(identified_categories)
}
```

#### Frequency table for observed side effects

```{r, echo=TRUE, fig.align='center'}
# Get the side effects data
side_effects_data <- na.omit(data.frame(SideEffects = original_data$`Observed side effects`))
side_effects_data$Category <- sapply(side_effects_data$SideEffects, function(effect) {
  category <- categorize_effects(effect)
  paste(category, collapse = " + ")
})
print(side_effects_data)

# Frequency table
table(side_effects_data$Category)
```