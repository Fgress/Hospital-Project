---
title: "Second Draft Report: Group 6 Ametop Study with Dr. Louis Scheepers"
output: pdf_document
date: "25 March 2024"
header-includes:
   - \usepackage{multirow}
   - \usepackage{float}
     \let\origfigure\figure
     \let\endorigfigure\endfigure
     \renewenvironment{figure}[1][2] {
     \expandafter\origfigure\expandafter[H]
     } {
      \endorigfigure
     }
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
# Set up echo as false to not print the R code in the report
library(knitr)
library(readxl)
library(ggplot2)
library(tidyverse)
library(gridExtra)
ggplot2::theme_set(theme_classic())
options(repr.plot.width=20, repr.plot.height=20)
```


\begin{center}
Fabiola Grace

Maggie Ruan

Runhe Guo

Yimin You

\end{center}

\newpage

# Summary

This study compares the efficacy of two approaches: Ametop alone and Ametop combined with a vapocoolant spray, in alleviating pain during IV insertion. In the experiment, pain levels were assessed alongside secondary outcomes. Statistical analyses revealed that the addition of vapocoolant spray may not significantly reduce discomfort in pediatric patients. However, age, number of IV attempts, and practitioner's role emerged as significant factors influencing pain levels, highlighting the importance of personalized care in pediatric anesthesia practices. These findings contribute to optimizing pain management strategies and improving patient outcomes in pediatric anesthesia.

# Introduction 

Pediatric patients commonly experience anxiety and discomfort during IV insertion. In this study, we aim to compare the efficacy of two pain management strategies to improve pediatric anesthesia practices and alleviate the pain associated with this procedure: Ametop alone and its combination with a vapocoolant spray. The research employed a randomized controlled trial to assess pain levels experienced by children, while also exploring secondary outcomes such as the impact of provider experience, gender, and age-related differences in pain perception. Our statistical analysis will utilize a t-test to assess the primary outcome of pain reduction due to the addition of vapocoolant spray, a linear regression analysis to investigate the impact of other factors on pain levels and pie charts to visualize the distribution of side effects.

# Data description 
The study retrospectively collected data from 240 pediatric patients undergoing intravenous (IV) insertion. There were 9 controlled variables to ensure the consistency of the participants in the experiment. Some participants withdrew from the study, citing reasons such as conversion to inhalation induction, Ametop-induced itchiness requiring removal. As these cases lacked sufficient information in recording the response variables, the missing variables cannot be addressed through imputations or other methods. Consequently, we excluded these 17 observations, focusing solely on the remaining 223 observations for main and secondary objective 1.
The dataset has several key variables, categorized as follows:


- **Patient Demographics:** This includes variables such as age, gender, and ASA classification, which are crucial for subgroup analyses. Age (5-16 years old) is particularly important for determining if responses to pain management strategies vary among different pediatric age groups.
- **Treatment Group Randomization:** Patients are randomly assigned to one of two groups: Group 1, receiving Ametop alone (the control group), and Group 2, receiving both Ametop and the vapocoolant spray (the study group). This randomization is essential for assessing the comparative effectiveness of the two treatment approaches.
- **FPS-R Scores:** Patients rated their pain using the FPS-R scale from 0 (no pain) to 10 (worst pain possible), offering a measurable discomfort level during IV insertion. This score determines the primary outcome, comparing the effectiveness of treatment approaches.
- **Observer’s Scores:** The patients’ discomfort is observed and rated by a nurse on a 3-point scale: ‘none,’ ‘slight,’ or ‘severe’ to capture visible signs of discomfort or pain. This complements FPS-R scores, ensuring reliable pain assessment in children, as some children may be playful or may not fully understand the meaning of the pictograms provided. 
- **Number of IV Attempts:** This variable records the number of attempts required to successfully insert the IV, reflecting the procedural difficulty and its potential correlation with patient discomfort.
- **Needle Gauge:** The size of the needle used, differentiated as “22” being slightly larger than “24,” was accounted for in the analysis due to its potential influence on discomfort levels.
- **Practitioner’s role:** The practitioner is either a resident or an anesthetist which may result in a difference in pain level felt by the patient.
- **Side Effects:** Side effects were monitored to ensure uniform treatment across participants.

# Methods

**Main Objective: Does the combination of Ametop with a vapocoolant spray significantly reduce the discomfort experienced by pediatric patients during IV insertions, compared to the application of Ametop alone?**

The main challenge in assessing our primary objective lies in the presence of two target responses: the FPS-R scores selected by the patients and the observer's scores. Accurately measuring pain in children using FPS-R scores alone can be difficult, as some children may be playful or might not fully comprehend the pictograms provided. Thus, the observer’s scores serve as an additional target response, intended to confirm the reliability of the FPS-R scores. While the patient’s FPS-R score remains the focal point, its alignment with the observer’s scores is necessary. Consequently, we will conduct the statistical analysis and testing in two ways: a test covering the entire dataset, and a second test limited to a subset of data where the observer's scores and the patient's FPS-R score align.

\begin{table}[ht]
\centering
\begin{tabular}{|c|c|c|c|c|}
    \hline
    \multicolumn{2}{|c|}{} & \multicolumn{3}{c|}{FPS-R Score}\\
    \cline{3-5}
    \multicolumn{2}{|c|}{\multirow{-2}{*}{}} & 0 \& 2 & 4 \& 6 & 8 \& 10\\
    \hline
    \multirow{3}{*}{\rotatebox{90}{Observer's Score}} & Severe & 0 & 0 & 5\\[0.46cm]
    \cline{2-5}
    & Slight & 24 & 24 & 12\\[0.46cm]
    \cline{2-5}
    & None & 135 & 20 & 3\\[0.46cm]
    \hline
\end{tabular}
\caption{Count of matches in data}
\end{table}

Table 1 shows the total number of patients where the observer's scores and the patient's FPS-R score align and where it does not align. To create the subset of data where the score matches, we use the following: 

* FPS-R scores 0 and 2 matched with the observer’s score 'None' = 135 patients
* FPS-R scores 4 and 6 matched with the observer’s score 'Slight Pain' = 24 patients
* FPS-R scores 8 and 10 matched with the observer’s score 'Severe Pain' = 5 patients

Before carrying out the statistical test, we will perform exploratory data analysis to examine the distribution of the target response, the FPS-R score.

```{r, out.width="75%", fig.align='center', fig.cap = "Boxplots of Control and Study Group for Full and Subset Data"}
# Read data
file_path <- "../data/Ametop-PE data(new-Alex)(1control 2study).xlsx"
original_data <- read_excel(file_path)

# Save original data for side effects analysis
data <- original_data

# Remove withdrawn patients
data <- data[data$`Withdrawn after consent?` != "Yes", ]

# Remove unnecessary variables
data <- select(data, 
               -`Elective surgery requiring IV?`,
               -`ASA I or II?`,
               -`Aged 5-16?`,
               -`Any allergies to Ametop, Pain Ease, or Tagederm adhesive?`,
               -`Ametop placed at least 30min before estimated IV start time?`,
               -`Receiving sedative pre-medication / anxiolytics?`,
               -`Needle phobia?`,
               -`Planned inhalation induction?`,
               -`Developmental delay or unable to interpret FPS-R?`,
               -`Time Ametop applied`,
               -`Time Ametop removed`,
               -`Time of skin puncture`,
               -`Record ID`,
               -`Complete?`,
               -`Withdrawn after consent?`,
               -`Reason for withdrawal`,
               -`Other reason for withdrawal`)

# Shorten the data
data$`Reaction to skin puncture` <- gsub("^(Slight|Severe).*", "\\1 Pain",
                                         data$`Reaction to skin puncture`)

data$`Observer Number` <- case_when(
  data$`Reaction to skin puncture` == "None" ~ 1,
  data$`Reaction to skin puncture` == "Slight Pain" ~ 2,
  data$`Reaction to skin puncture` == "Severe Pain" ~ 3
)

# Create 'FPS-R Number'
data$`FPS-R Number` <- case_when(
  data$`FPS-R score` %in% c(0, 2) ~ 1,
  data$`FPS-R score` %in% c(4, 6) ~ 2,
  data$`FPS-R score` %in% c(8, 10) ~ 3
)

# Create 'Match Responses'
data$`Match Responses` <- ifelse(data$`Observer Number` == data$`FPS-R Number`, "Yes", "No")

# Create data subset for match data
data_subset <- data[data$`Match Responses` == 'Yes',]

# Boxplots
plot3 <- data %>% filter(Randomization == 1) %>%
  ggplot(aes(`FPS-R score`)) +
  geom_boxplot() +
  labs(title = "Full Data Control Group Boxplot")

plot4 <- data %>% filter(Randomization == 2) %>%
  ggplot(aes(`FPS-R score`)) +
  geom_boxplot() +
  labs(title = "Full Data Study Group Boxplot")

plot5 <- data %>% filter(Randomization == 1, `Match Responses` == "Yes") %>%
  ggplot(aes(`FPS-R score`)) +
  geom_boxplot() +
  labs(title = "Match Subset Control Group Boxplot")

plot6 <- data %>% filter(Randomization == 2, `Match Responses` == "Yes") %>%
  ggplot(aes(`FPS-R score`)) +
  geom_boxplot() +
  labs(title = "Match Subset Study Group Boxplot")

grid.arrange(plot3, plot4, plot5, plot6, ncol = 2, nrow = 2)
```

From Figure 1, we observe that the median FPS-R score for both the control and treatment groups is 2. The treatment group's data shows a higher concentration of scores at FPS-R 0 and 2, and is right-skewed. When examining the boxplot of the subset of data where the FPS-R scores and observer's scores align, their distributions do not appear significantly different. 

The statistical method used to assess whether the addition of vapocoolant spray reduces discomfort is the Welch Two Sample T-Test. This test is applied under the assumption that the differences between the control group and the study group follow a Normal distribution, as per the Central Limit Theorem (CLT). We conduct the t-test twice: first on the entire dataset, and second on the subset of data where the FPS-R scores and observer’s scores match. The null hypothesis is that the mean pain level is the same for both treatment groups, while the alternative hypothesis is that the mean pain level is lower for the treatment group using the vapocoolant spray compared to the group using Ametop alone. Thus, the test is a one-sided t-test. In accordance with Dr. Louis Scheepers' recommendation, the threshold for p-value significance is set at a 5% significance level.

**Secondary Objective 1: Do age, gender, the practitioner’s role, the number of IV attempts, and the needle gauge used to influence the level of pain experienced by pediatric patients during IV insertion?**

To examine the objective at hand, we constructed two models on the matched subset data for consistency with the first objective. The first model included only the listed five main effects, serving as the base model while the second model introduced interaction effects. The null hypothesis posited that there is no relationship between the dependent variables and the FPS-R Score, while the alternative hypothesis suggested the presence of such a relationship.

Firstly, we conducted linear regression solely on the main effects, adhering to a 5% significance level. Secondly, we investigated how the relationship between one categorical factor and the FPS-R score depends on the value of the second categorical factor. We grouped the age variable into two groups, 5-10 and 11-16 to consider children’s development. Additionally, we categorized the number of IV attempts into low and high. Then, we paired all five main effects and generated interaction plots. If the lines intersect, indicating an interaction between the selected two variables, we included the interaction term in the regression model. Once all terms, including the interaction effects, were incorporated, we performed linear regression again.

**Secondary Objective 2: The incidence of side effects due to Ametop or the vapocoolant spray.**
	
**Study Design and Participants:**
All participants initially included in the study were considered in the analysis, even those who withdrew before its conclusion, to consider patients who withdrew due to experiencing side effects and preserving the comprehensive nature of the data. Thus, all 240 participants of the study are included in this objective’s analysis.

**Side Effects Categorization:**
Categories of observed side effects were extracted from the ‘Observed side effects’ column, where side effects of patients ranged from “Slight redness of skin from Ametop” to “quite red & itchy skin from Ametop. Underlying eczema.” These reports were categorized into distinct groups such as the individual side effect “Redness” and the combined side effect “Redness + Itching” to facilitate the quantitative analysis of side effects. 

# Result

**Main Objective: Does the combination of Ametop with a vapocoolant spray significantly reduce the discomfort experienced by pediatric patients during IV insertions, compared to the application of Ametop alone?**

Using the entire dataset, the result of the Welch Two Sample T-Test yields a p-value of 0.02258. This suggests that we can reject the null hypothesis at a 5% significance level, indicating that the mean pain level is not the same for both the control and study groups. This supports the idea that the addition of vapocoolant spray may reduce discomfort in pediatric patients.

However, when conducting the t-test on the subset of data where the FPS-R scores and observer's scores align, we obtain a p-value of 0.0594. This suggests that we cannot reject the null hypothesis at a 5% significance level, indicating that the mean pain level is the same for both the control and study groups, and we cannot conclude that the vapocoolant spray reduces discomfort.

**Secondary Objective 1: Do age, gender, the practitioner’s role, the number of IV attempts, and the needle gauge used to influence the level of pain experienced by pediatric patients during IV insertion?**

**Base Model:**

**Age:** The coefficient for Age is -0.11476, which is statistically significant (p < 0.05). This implies that for each additional year of age, the FPS-R score decreases by approximately 0.115 points, suggesting that older children experience slightly less discomfort during IV insertions.

**Number of IV Attempts:** This coefficient is positive and significant (p < 0.05), indicating that an increased number of IV attempts is associated with a higher FPS-R score, suggesting greater discomfort with more attempts.

Out of 5 main effects (age, gender, the practitioner’s role, the number of IV attempts, and the needle gauge) in the base model, only the above two are significant.

**Interaction Model:**

There are several significant interactions gathered from the interaction plot: Sex and Age, Sex and Needle gauge, Sex and Practitioner, Age and Needle gauge, Age and Practitioner, Number of IV attempts and Practitioner. All these interactions and the five main effects are included in this more comprehensive regression model. (Interaction plots attached in appendix)

**Age and Practitioner Interaction:** The interaction between age and practitioner type is also significant (p < 0.05) with a negative coefficient (-0.412774). This indicates that the effect of a resident performing the procedure has a differential impact based on the patient's age. Specifically, the increase in discomfort associated with a resident performing the IV insertion diminishes as the patient gets older.

**Practitioner:** There was a significant positive coefficient for practitioners with resident status (p < 0.05), suggesting that when residents instead of anesthetists performed the IV insertion, there was an increase in the FPS-R score, which could be interpreted as an increase in perceived discomfort.

These results suggest that the discomfort during IV insertions is influenced not just by the number of attempts or the age of the patient but also by the experience level of the practitioner, and this effect varies with the age of the patient. It highlights the importance of considering these interactions when planning and training for IV insertions to optimize patient comfort.

**Secondary Objective 2: The incidence of side effects due to Ametop or the vapocoolant spray.**

**Proportions of patients with or without observed side effects**

```{r}
# Pie chart draw function with percentages
draw_pie_chart <- function(all_categories, title) {
  # Count the occurrences of each category
  category_counts <- table(all_categories)

  # Calculate the percentage for each category
  percentages <- round(category_counts / sum(category_counts) * 100, 1)

  # Create labels that include both the category name and the percentage
  labels <- paste(names(category_counts), " - ", percentages, "%", sep="")

  pie(category_counts,
      main = title,
      col = c("#219ebc", "#fb8500"),
      labels = labels,
      cex = 1.0)
}
```

```{r, fig.align='center', fig.cap = "Pie chart for Observed side effects"}
# Summarize "Any side effects observed?" column
side_effects_observed_summary <- data.frame(original_data$`Any side effects observed?`)

# Create a pie chart for the observed side effects
draw_pie_chart(side_effects_observed_summary, "Observed Side Effects")
```

As illustrated in Figure 2, the vast majority of study participants, 95%, reported no side effects, indicating a high level of tolerance for both treatments, with 5% of patients experiencing side effects.

**Side effects**

```{r, fig.align='center'}
side_effects_data <- data.frame(
  `Side Effects Description` = c(
    "Slight redness of skin from ametop",
    "Some redness on skin, more than usual",
    "vey mild pink and pruritic skin.",
    "complained of pain on the spray.",
    "slightly puffy hands after ametop removal",
    "pink skin and very mild itching",
    "redness from ametop",
    "quite red & itchy skin from ametop. Underlying eczema.",
    "redness at ametop site. Not painful or pruritic.",
    "redness & raised area under ametop",
    "quite itchy from ametop. Redness.",
    "Slight redness from ametop. No pruritis."
  ),
  Category = c(
    "Redness",
    "Redness",
    "Redness + Itching",
    "Pain",
    "Puffiness",
    "Redness + Itching",
    "Redness",
    "Redness + Itching",
    "Redness",
    "Redness",
    "Redness + Itching",
    "Redness"
  ),
  check.names = FALSE
)

kable(side_effects_data, caption = "Side Effects Category")
```

```{r}
side_effects_data <- data.frame(
  Category = c("Pain", "Puffiness", "Redness only", "Redness + Itching"),
  Counts = c("1", "1", "6", "4")
)

kable(side_effects_data, caption = "Side Effects Category Counts")
```

As shown in Table 2 and Table 3, the most common side effect reported for patients was redness, either alone or accompanied by itching.

# Conclusion

The conclusion of our main objective, which is to determine whether the addition of vapocoolant spray significantly reduces discomfort experienced by pediatric patients during IV insertions compared to Ametop alone, depends on the dataset used. When analyzing the full dataset, the results suggest that the addition of vapocoolant spray does significantly reduce discomfort. However, when examining the subset of data where the FPS-R scores and observer's scores align, there appears to be no significant difference in discomfort between the control and study groups. We favor the results from the subset data as it indicates more reliable and higher-quality data. Nonetheless, we acknowledge limitations in how the data is subsetted and plan to discuss with the client in our second meeting potential alternative methods for subsetting the data to improve results without introducing bias or removing too many observations.

Regarding our secondary objective, which is to identify other variables that influence the level of pain experienced by pediatric patients during IV insertion, we conclude that age, number of IV attempts, and practitioner's role are significant factors. It emphasizes the significance of taking these factors into account during IV insertions to alleviate patients' discomfort. A limitation observed in this regression method is that the data does not appear to be exactly normally distributed, as indicated by the QQ plot, which shows a heavy-tailed distribution. However, since the group is focusing on inference rather than prediction, and considering the Central Limit Theorem (CLT) assumption, we will still proceed with using linear regression for our analysis.

The inability to reject the null hypothesis in our main objective could be explained by the significant variables found in the regression model. Age, practitioner roles, and number of IV attempts have been identified as significant in influencing pain levels. Segmenting the data differently, perhaps by excluding certain age groups, number of IV attempts, or practitioner roles, might yield different results. Our next step is to retest the main objective, assessing whether there is a difference in the FPS-R scores between the control and study groups when segmented by age, practitioner role, and number of IV attempts, to see if this impacts the results in any way.

In analyzing the side effects of Ametop and its combination with a vapocoolant spray, it's evident that the majority of patients (95%) experience no side effects, underlining the treatments’ high tolerance. Among the 5% that do report side effects, the most common side effect reported for patients was redness, either alone or accompanied by itching. Overall, the observed variations in side effect profiles highlight the significance of personalized patient care and the broad range of reactions suggests that clinicians must exercise careful consideration when prescribing treatments.

\newpage

# References
Rogers TL, Ostrow CL. The use of EMLA cream to decrease venipuncture pain in children. Journal of Pediatric Nursing. 2004 Feb 1;19(1):33-9.

\newpage

# Appendix

## For client

\newpage

## For mentor

### Data cleaning

```{r, echo=TRUE}
# Read data
file_path <- "../data/Ametop-PE data(new-Alex)(1control 2study).xlsx"
original_data <- read_excel(file_path)

# Save original data for side effects analysis
data <- original_data

# Remove withdrawn patients
data <- data[data$`Withdrawn after consent?` != "Yes", ]

# Remove unnecessary variables
data <- select(data, 
               -`Elective surgery requiring IV?`,
               -`ASA I or II?`,
               -`Aged 5-16?`,
               -`Any allergies to Ametop, Pain Ease, or Tagederm adhesive?`,
               -`Ametop placed at least 30min before estimated IV start time?`,
               -`Receiving sedative pre-medication / anxiolytics?`,
               -`Needle phobia?`,
               -`Planned inhalation induction?`,
               -`Developmental delay or unable to interpret FPS-R?`,
               -`Time Ametop applied`,
               -`Time Ametop removed`,
               -`Time of skin puncture`,
               -`Record ID`,
               -`Complete?`,
               -`Withdrawn after consent?`,
               -`Reason for withdrawal`,
               -`Other reason for withdrawal`)
```

```{r, echo=TRUE}
# Check for missing values in all columns except 'Notes' and 'Observed side effects'
missing_values_summary <- data %>%
  select(-Notes, -`Observed side effects`) %>%
  summarise_all(~sum(is.na(.)))

# No missing values found
print(missing_values_summary)
```

```{r, echo=TRUE}
# Shorten the data
data$`Reaction to skin puncture` <- gsub("^(Slight|Severe).*", "\\1 Pain",
                                         data$`Reaction to skin puncture`)

# Verify the changes
table(data$`Reaction to skin puncture`)
```

### Data preprocessing

```{r, echo=TRUE}
# Create new variables for the dataset

# Create 'Observer Number'
data$`Observer Number` <- case_when(
  data$`Reaction to skin puncture` == "None" ~ 1,
  data$`Reaction to skin puncture` == "Slight Pain" ~ 2,
  data$`Reaction to skin puncture` == "Severe Pain" ~ 3
)

# Create 'FPS-R Number'
data$`FPS-R Number` <- case_when(
  data$`FPS-R score` %in% c(0, 2) ~ 1,
  data$`FPS-R score` %in% c(4, 6) ~ 2,
  data$`FPS-R score` %in% c(8, 10) ~ 3
)

# Create 'Match Responses'
data$`Match Responses` <- ifelse(data$`Observer Number` == data$`FPS-R Number`, "Yes", "No")

# Create data subset for match data
data_subset <- data[data$`Match Responses` == 'Yes',]
```

```{r, echo=TRUE}
# Verify data
head(data)
```

### Objective 1

#### Histrograms and boxplots

```{r, echo=TRUE, fig.align='center'}
# Histograms
plot1 <- data %>% filter(Randomization == 1) %>%
  ggplot(aes(`FPS-R score`)) +
  geom_histogram() +
  labs(title = "Group 1 Histogram")

plot2 <- data %>% filter(Randomization == 2) %>%
  ggplot(aes(`FPS-R score`)) +
  geom_histogram() +
  labs(title = "Group 2 Histogram")

# Boxplots
plot3 <- data %>% filter(Randomization == 1) %>%
  ggplot(aes(`FPS-R score`)) +
  geom_boxplot() +
  labs(title = "Full Data Group 1 Boxplot")

plot4 <- data %>% filter(Randomization == 2) %>%
  ggplot(aes(`FPS-R score`)) +
  geom_boxplot() +
  labs(title = "Full Data Group 2 Boxplot")

plot5 <- data %>% filter(Randomization == 1, `Match Responses` == "Yes") %>%
  ggplot(aes(`FPS-R score`)) +
  geom_boxplot() +
  labs(title = "Match Subset Data Group 1 Boxplot")

plot6 <- data %>% filter(Randomization == 2, `Match Responses` == "Yes") %>%
  ggplot(aes(`FPS-R score`)) +
  geom_boxplot() +
  labs(title = "Match Subset Data Group 2 Boxplot")

grid.arrange(plot1,plot2,plot3,plot4,plot5,plot6, ncol = 2, nrow = 3)
```

#### Table

```{r, echo=TRUE}
# Create a table to count matches
table <- table(data$`Observer Number`, data$`FPS-R Number`)

# Name the rows and columns to reflect the desired format
rownames(table) <- c("1", "2", "3")
colnames(table) <- c("1", "2", "3")

# Output the 3x3 table
cat("Contingency Table of FPS-R Number vs. Observer Number\n")
cat("Rows: FPS-R Number\n")
cat("Columns: Observer Number\n\n")
print(table)
```

#### T-tests

```{r, echo=TRUE}
# Perform t-test on full data
t_test_full <- t.test(data[data$Randomization == 2, ]$`FPS-R score`,
                      data[data$Randomization == 1, ]$`FPS-R score`,
                      alternative = c("less"))
print(t_test_full)

# Perform t-test on subset of data
t_test_subset <- t.test(data_subset[data_subset$Randomization == 2, ]$`FPS-R score`,
                        data_subset[data_subset$Randomization == 1, ]$`FPS-R score`, 
                        alternative = c("less"))
print(t_test_subset)

# Conclusion: We should only reject the null hypothesis based on the full dataset.
# If we consider the subset of data with 164 observations (after excluding 59
# from the original 223), we do not reject the null hypothesis.
```

### Objective 2

#### Linear regression of Age * Randomization group

```{r, echo=TRUE, fig.align='center'}
lm_age <- lm(`FPS-R score` ~ Age * factor(Randomization), data = data)
summary(lm_age)
```

```{r, echo=TRUE, fig.align='center'}
# Plot the linear regression line
ggplot(data, aes(x = Age, y = `FPS-R score`, color = factor(Randomization))) +
  # Add the regression line
  geom_smooth(method = "lm", se = FALSE) +
  # Set plot labels
  xlab("Age") +
  ylab("FPS-R score") +
  labs(color = "Randomization", title = "Figure 2: Linear Regression line for Control and Study Group") +
  scale_color_manual(values = c("#219ebc", "#fb8500"),
                     labels = c("Control Group", "Study Group")) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))
```

```{r, echo=TRUE, fig.align='center'}
# Number of IV Attempts analysis

# Summary statistics
data_control <- data[data$`Randomization` == 1,]
data_study <- data[data$`Randomization` == 2,]
summary(data_control$`Number of IV attempts`)
summary(data_study$`Number of IV attempts`)

# Mean for study group decreases instead

# Bar Chart for IV attempts
bar <- data %>%
  mutate(Group = ifelse(Randomization == 1, "Control Group", "Study Group")) %>%
  ggplot(aes(x = `Number of IV attempts`, fill = Group)) +
  geom_bar(position = "dodge") +
  scale_fill_manual(values = c("Control Group" = "#219ebc", "Study Group" = "#fb8500")) +
  labs(title = "Number of IV Attempts", x = "Number of IV Attempts",
    y = "Count", fill = "Group"
  ) +
    theme(
    plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
    legend.title = element_text(size = 16),
    legend.text = element_text(size = 16),
    axis.title.x = element_text(size = 16),
    axis.title.y = element_text(size = 16),
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12)
  )

print(bar)

# No need further testing, from EDA we can see that the study group 
# didn't increase number of IV attempts (in fact, it decreases)
# (note: we did try doing t-test for confirmation and we can't reject null)
```

### Objective 3

```{r, echo=TRUE}
# Pie chart draw function with percentages
draw_pie_chart <- function(all_categories, title) {
  # Count the occurrences of each category
  category_counts <- table(all_categories)

  # Calculate the percentage for each category
  percentages <- round(category_counts / sum(category_counts) * 100, 1)

  # Create labels that include both the category name and the percentage
  labels <- paste(names(category_counts), " - ", percentages, "%", sep="")
  
  pie(category_counts,
      main = title,
      col = c("#219ebc", "#fb8500"),
      labels = labels,
      cex = 1.0)
}
```

#### Pie chart for Observed side effects

```{r, echo=TRUE, fig.align='center'}
# Summarize "Any side effects observed?" column
side_effects_observed_summary <- data.frame(original_data$`Any side effects observed?`)

# Create a pie chart for the observed side effects
draw_pie_chart(side_effects_observed_summary, "Observed Side Effects")
```

```{r, echo=TRUE}
# Define the categorization function
categorize_effects <- function(effect) {
  effect_lower <- tolower(effect)
  categories <- list(
    Redness = "red|redness|pink",
    Itching = "itchy|pruritic|pruritis|itching",
    Pain = "pain|painful",
    Puffiness = "puffy"
  )

  identified_categories <- character(0)

  # Negation patterns
  pattern_start <- "\\b(no|not)\\s+("
  pattern_middle <- ")\\b|(no|not)\\s+\\w+\\s+or\\s+("
  pattern_end <- ")"

  for (category_name in names(categories)) {
    symptom_pattern <- categories[[category_name]]

    # Check for the symptom but exclude if negated
    if (grepl(symptom_pattern, effect_lower)) {
      negation_pattern <- paste0(
        pattern_start, symptom_pattern, pattern_middle, symptom_pattern, pattern_end)
      if (!grepl(negation_pattern, effect_lower)) {
        identified_categories <- c(identified_categories, category_name)
      }
    }
  }

  # Return "Other" if no category is found
  if (length(identified_categories) == 0) {
    return("Other")
  }

  return(identified_categories)
}
```

#### Frequency table for observed side effects

```{r, echo=TRUE, fig.align='center'}
# Get the side effects data
side_effects_data <- na.omit(data.frame(SideEffects = original_data$`Observed side effects`))
side_effects_data$Category <- sapply(side_effects_data$SideEffects, function(effect) {
  category <- categorize_effects(effect)
  paste(category, collapse = " + ")
})
print(side_effects_data)

# Frequency table
table(side_effects_data$Category)
```