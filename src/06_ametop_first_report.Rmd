---
output:
  pdf_document: default
  html_document: default
---

## Import libraries

```{r}
library(readxl)
library(dplyr)
library(ggplot2)
library(GGally)
library(reshape)
library(nnet)
library(stats)
```

## Data cleaning

```{r}
# Read data
data <- read_excel("../data/Ametop-PE data(new-Alex)(1control 2study).xlsx")

# Remove withdrawn patients
data <- data[data$`Withdrawn after consent?` != "Yes", ]

# Remove unnecessary variables
data <- select(data, 
               -`Elective surgery requiring IV?`,
               -`ASA I or II?`,
               -`Aged 5-16?`,
               -`Any allergies to Ametop, Pain Ease, or Tagederm adhesive?`,
               -`Ametop placed at least 30min before estimated IV start time?`,
               -`Receiving sedative pre-medication / anxiolytics?`,
               -`Needle phobia?`,
               -`Planned inhalation induction?`,
               -`Developmental delay or unable to interpret FPS-R?`,
               -`Time Ametop applied`,
               -`Time Ametop removed`,
               -`Time of skin puncture`,
               -`Record ID`,
               -`Complete?`,
               -`Withdrawn after consent?`,
               -`Reason for withdrawal`,
               -`Other reason for withdrawal`)


```

```{r}
# Check for missing values in all columns except 'Notes' and 'Observed side effects'
missing_values_summary <- data %>%
  select(-Notes, -`Observed side effects`) %>%
  summarise_all(~sum(is.na(.)))

# No missing values found
print(missing_values_summary)

```

```{r}
#Shorten the data
data$`Reaction to skin puncture` <- gsub("^Slight.*", "Slight Pain", data$`Reaction to skin puncture`)

data$`Reaction to skin puncture` <- gsub("^Severe.*", "Severe Pain", data$`Reaction to skin puncture`)

# Verify the changes
table(data$`Reaction to skin puncture`)
```

## Data preprocessing

```{r}
# Creating new variables for the dataset

# Create 'Observer Number'
data$`Observer Number` <- case_when(
  data$`Reaction to skin puncture` == "None" ~ 1,
  data$`Reaction to skin puncture` == "Slight Pain" ~ 2,
  data$`Reaction to skin puncture` == "Severe Pain" ~ 3
)

# Create 'FPS-R Number'
data$`FPS-R Number` <- case_when(
  data$`FPS-R score` %in% c(0, 2) ~ 1,
  data$`FPS-R score` %in% c(4, 6) ~ 2,
  data$`FPS-R score` %in% c(8, 10) ~ 3
)

# 3. Create 'Match Responses'
data$`Match Responses` <- ifelse(data$`Observer Number` == data$`FPS-R Number`, "Yes", "No")
```

```{r}
# Verify data
head(data)
```

## Data analysis

```{r}
# Compare the sample sizes between the control group and the study group
table(data$Randomization)
```




```{r}
# Recoding 'Match Responses' to binary (0 = No, 1 = Yes)
data$Match_Responses_Binary <- ifelse(data$`Match Responses` == "Yes", 1, 0)



# Fitting the logistic model with interactions 
logit_model <- glm(Match_Responses_Binary ~ data$`Age` + data$`Sex` + data$`Practitioner` + data$`Number of IV attempts` + data$`Needle gauge` + data$`Age`*data$`Sex`, 
                   family = binomial(link = "logit"), data = data)
```




```{r}
#summary of the logistic model
summary(logit_model)
```
```{r}
# Calculating residuals
dev_res <- residuals(logit_model, type = "deviance")

# Plotting residuals
plot(dev_res, ylab = "Residuals", xlab = "Index", main = "Residuals Plot")
abline(h = 0, col = "red")

# Calculating fitted probabilities
fitted_probs <- predict(logit_model, type = "response")

# Plotting residuals vs. fitted values
plot(fitted_probs, dev_res, ylab = "Residuals", xlab = "Fitted Probabilities", main = "Residuals vs. Fitted Values")
abline(h = 0, col = "red")


# QQ plot of residuals(general)
qqnorm(dev_res)
qqline(dev_res, col = "red")
title("QQ Plot of Residuals")

```

```{r}
# Summarize "Any side effects observed?" Column
side_effects_observed_summary <- table(data$`Any side effects observed?`)

# Calculate percentages
percentages <- round(100 * side_effects_observed_summary / sum(side_effects_observed_summary), 1)

# Generate labels with percentages
labels <- paste(names(side_effects_observed_summary), "-", percentages, "%", sep="")

# Pie Chart for "Any side effects observed?"
pie(side_effects_observed_summary,
    main = "Proportion of Patients with Any Observed Side Effects",
    col = c("lightgreen", "lightcoral"))

# Pie Chart for "Any side effects observed?" with percentages
pie(side_effects_observed_summary,
    main = "Proportion of Patients with Any Observed Side Effects",
    col = c("lightgreen", "lightcoral"),
    labels = labels)
```




```{r}
# Assuming the column name is "Observed side effects"
specific_side_effects_summary <- table(data$`Observed side effects`)


# Creating a pie chart with the "Observed side effects"
pie(specific_side_effects_summary,
    main = "Distribution of Specific Side Effects",
    col = rainbow(length(specific_side_effects_summary)),
    labels = paste(names(specific_side_effects_summary), ": ", 
                   round(100 * specific_side_effects_summary / sum(specific_side_effects_summary), 1), "%", sep=""))





```
# Do age, gender, the practitioner's role (anesthetist or resident), the number of IV attempts, and the needle gauge used (24 or 22 gauge) influence the level of pain experienced by pediatric patients during IV insertion?

```{r}
# Correlation Matrix: age, sex, practitioner, number of IV attempts, Ametop or vapocoolant spray, needle gauge (22 or 24), and their interaction with the assigned randomization group
data$sex <- ifelse(data$Sex == "Male", 1, 0)
data$practitioner <- ifelse(data$Practitioner == "Anesthetist", 1, 0)

numerical_data <- data %>% select(Age, sex, practitioner, `Number of IV attempts`, Randomization, `Needle gauge`, `Observer Number`, `FPS-R Number`)
cors <- numerical_data %>% cor(use = "complete.obs")
melted_cors <- suppressWarnings(melt(cors, na.rm = TRUE))
print(melted_cors)

ggplot(melted_cors, aes(melted_cors[,1], melted_cors[,2], fill = value)) +
  geom_tile(color = 'white') +
  scale_fill_gradient2(low = 'blue', high = 'red', mid = 'white', midpoint = 0, limit = c(-1, 1), space = 'Lab', name = 'Pearson r') +
  geom_text(aes(label = round(value, 2)), color = "black", size = 4) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, size = 10, hjust = 1)) +
  xlab("") + ylab("")
```

```{r}
# Multinomial logistic regression on `Observer Number`: 
# Observer Number ~ Age + sex + practitioner + `Number of IV attempts` + `Randomization` + `Needle gauge`
model_observer <- multinom(`Observer Number` ~ Age + sex + practitioner + `Number of IV attempts` + Randomization + `Needle gauge` + Age * `Needle gauge` + practitioner * `Needle gauge`, data=data)

summary(model_observer)
```

```{r}
# Multinomial logistic regression on `FPS-R Number`: 
# FPS-R Number ~ Age + sex + practitioner + `Number of IV attempts` + `Randomization` + `Needle gauge`
model_FPSR <- multinom(`FPS-R Number` ~ Age + sex + practitioner + `Number of IV attempts` + Randomization + `Needle gauge` + Age * `Needle gauge` + practitioner * `Needle gauge`, data=data)

summary(model_FPSR)
```

