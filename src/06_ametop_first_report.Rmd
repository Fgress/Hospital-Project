---
output:
  pdf_document: default
  html_document: default
---

## Import libraries

```{r}
library(readxl)
library(ggplot2)
library(tidyverse)
ggplot2::theme_set(theme_classic())
options(repr.plot.width=15, repr.plot.height=7.5)
```

## Data cleaning

```{r}
# Read data
file_path <- "../data/Ametop-PE data(new-Alex)(1control 2study).xlsx"
original_data <- read_excel(file_path)

# Save original data for side effects analysis
data <- original_data

# Remove withdrawn patients
data <- data[data$`Withdrawn after consent?` != "Yes", ]

# Remove unnecessary variables
data <- select(data, 
               -`Elective surgery requiring IV?`,
               -`ASA I or II?`,
               -`Aged 5-16?`,
               -`Any allergies to Ametop, Pain Ease, or Tagederm adhesive?`,
               -`Ametop placed at least 30min before estimated IV start time?`,
               -`Receiving sedative pre-medication / anxiolytics?`,
               -`Needle phobia?`,
               -`Planned inhalation induction?`,
               -`Developmental delay or unable to interpret FPS-R?`,
               -`Time Ametop applied`,
               -`Time Ametop removed`,
               -`Time of skin puncture`,
               -`Record ID`,
               -`Complete?`,
               -`Withdrawn after consent?`,
               -`Reason for withdrawal`,
               -`Other reason for withdrawal`)
```

```{r}
# Check for missing values in all columns except 'Notes' and 'Observed side effects'
missing_values_summary <- data %>%
  select(-Notes, -`Observed side effects`) %>%
  summarise_all(~sum(is.na(.)))

# No missing values found
print(missing_values_summary)
```

```{r}
# Shorten the data
data$`Reaction to skin puncture` <- gsub("^(Slight|Severe).*", "\\1 Pain",
                                         data$`Reaction to skin puncture`)

# Verify the changes
table(data$`Reaction to skin puncture`)
```

## Data preprocessing

```{r}
# Create new variables for the dataset

# Create 'Observer Number'
data$`Observer Number` <- case_when(
  data$`Reaction to skin puncture` == "None" ~ 1,
  data$`Reaction to skin puncture` == "Slight Pain" ~ 2,
  data$`Reaction to skin puncture` == "Severe Pain" ~ 3
)

# Create 'FPS-R Number'
data$`FPS-R Number` <- case_when(
  data$`FPS-R score` %in% c(0, 2) ~ 1,
  data$`FPS-R score` %in% c(4, 6) ~ 2,
  data$`FPS-R score` %in% c(8, 10) ~ 3
)

# Create 'Match Responses'
data$`Match Responses` <- ifelse(data$`Observer Number` == data$`FPS-R Number`, "Yes", "No")
```

```{r}
# Verify data
head(data)
```

## Objective 1

# Histrograms and Boxplots

```{r}
# Histogram
plot1 <- data %>% filter(Randomization == 1) %>%
  ggplot(aes(`FPS-R score`)) +
  geom_histogram() +
  labs(title = "Group 1 Histogram")

plot2 <- data %>% filter(Randomization == 2) %>%
  ggplot(aes(`FPS-R score`)) +
  geom_histogram() +
  labs(title = "Group 2 Histogram")

# Boxplot
plot3 <- data %>% filter(Randomization == 1) %>%
  ggplot(aes(`FPS-R score`)) +
  geom_boxplot() +
  labs(title = "Full Data Group 1 Boxplot")

plot4 <- data %>% filter(Randomization == 2) %>%
  ggplot(aes(`FPS-R score`)) +
  geom_boxplot() +
  labs(title = "Full Data Group 2 Boxplot")

# Boxplot
plot5 <- data %>% filter(Randomization == 1, `Match Responses` == "Yes") %>%
  ggplot(aes(`FPS-R score`)) +
  geom_boxplot() +
  labs(title = "Match Subset Data Group 1 Boxplot")

plot6 <- data %>% filter(Randomization == 2, `Match Responses` == "Yes") %>%
  ggplot(aes(`FPS-R score`)) +
  geom_boxplot() +
  labs(title = "Match Subset Data Group 2 Boxplot")

# Load the patchwork library
library(patchwork)

# Combine the plots
cat("Group 1 = Control group\nGroup 2 = Study group")
combined_plot <- (plot1 | plot2) / 
                 (plot3 | plot4) / 
                 (plot5 | plot6)
print(combined_plot)
```
# Table

```{r}
# Create a table to count matches
table <- table(data$`Observer Number`, data$`FPS-R Number`)

# Name the rows and columns to reflect the desired format
rownames(table) <- c("1", "2", "3")
colnames(table) <- c("1", "2", "3")

# Output the 3x3 table
cat("Contingency Table of FPS-R Number vs. Observer Number\n")
cat("Rows: FPS-R Number\n")
cat("Columns: Observer Number\n\n")
print(table)
```

# T-tests

```{r}
# Perform t-test on full data
t_test_full <- t.test(data[data$Randomization == 1, ]$`FPS-R score`,
                      data[data$Randomization == 2, ]$`FPS-R score`)
print(t_test_full)

# Perform t-test on subset of data
data_subset <- data[data$`Match Responses` == 'Yes',]
t_test_subset <- t.test(data_subset[data_subset$Randomization == 1, ]$`FPS-R score`,
                        data_subset[data_subset$Randomization == 2, ]$`FPS-R score`)
print(t_test_subset)

# Conclusion: We should only reject the null hypothesis based on the full dataset.
# If we consider the subset of data with 164 observations (after excluding 59
# from the original 223), we do not reject the null hypothesis.
```

## Objective 2

# Interaction plots

```{r}
# Only use match subset data
data = data[data$`Match Responses` == "Yes",]

# Convert continuous variables to categorical factors
data$Age_Group <- cut(data$Age, breaks = 2, labels = c("5-10", "11-16")) 
data$IV_Attempts_Group <- cut(data$`Number of IV attempts`, breaks = 2, labels = c("Low", "High"))

# Make sure all categorical variables are treated as factors
data$`Needle gauge` <- as.factor(data$`Needle gauge`)
data$Sex <- as.factor(data$Sex)
data$Practitioner <- as.factor(data$Practitioner)

# List of categorical variables
categorical_vars <- c("Sex", "Age_Group", "IV_Attempts_Group", "Needle gauge", "Practitioner")

# Create interaction plots for all pairs of categorical variables
for (x_var in categorical_vars) {
  for (trace_var in categorical_vars) {
    if (x_var != trace_var) {  # Avoid plotting a variable against itself
      interaction.plot(x.factor = data[[x_var]],
                       trace.factor = data[[trace_var]],
                       response = data$`FPS-R score`,
                       type = "b",
                       pch = 19,
                       xlab = x_var,
                       ylab = "FPS-R Score",
                       trace.label = trace_var,
                       col = c("red", "blue"),
                       lty = 1,
                       legend = TRUE,
                       main = paste("Interaction Plot:", x_var, "vs", trace_var))
    }
  }
}

# Significant interactions: Sex * Age + Sex * `Needle gauge` + Sex * Practitioner
# + Age * `Needle gauge` + Age * Practitioner + `Number of IV attempts` * Practitioner
```

# Histograms for FPS-R score

```{r}
data %>% 
    ggplot(aes(x = Age, y = `FPS-R score`)) +
    geom_point(size=4) +
    theme(text = element_text(size=25)) +
    scale_y_continuous(breaks=0:10) +
    labs(x = "Age",
         y = "FPS-R score")

# The younger the age, the more concentrated the distribution of pain scores.
```

```{r}
data %>% 
    ggplot(aes(x = Sex, y = `FPS-R score`)) +
    geom_point(size=4) +
    theme(text = element_text(size=25)) +
    scale_y_continuous(breaks=0:10) +
    labs(x = "Sex",
         y = "FPS-R score")
```

```{r}
data %>% 
    ggplot(aes(x = `Practitioner`, y = `FPS-R score`)) +
    geom_point(size=4) +
    theme(text = element_text(size=25)) +
    scale_y_continuous(breaks=0:10) +
    labs(x = "Practitioner",
         y = "FPS-R score")
```

```{r}
data %>% 
    ggplot(aes(x = `Number of IV attempts`, y = `FPS-R score`)) +
    geom_point(size=4) +
    theme(text = element_text(size=25)) +
    scale_y_continuous(breaks=0:10) +
    labs(x = "Number of IV attempts",
         y = "FPS-R score")
# The fewer the number of IV injections, the more concentrated the high pain scores are.
```

```{r}
data %>% 
    ggplot(aes(x = `Needle gauge`, y = `FPS-R score`)) +
    geom_point(size=4) +
    theme(text = element_text(size=25)) +
    scale_y_continuous(breaks=0:10) +
    labs(x = "Needle gauge",
         y = "FPS-R score")
```

# Linear models for FPS-R score

```{r}
data_subset <- data[data$`Match Responses` == 'Yes',]

lm_model_without_interactions <- lm(`FPS-R score` ~ Age + Sex + Practitioner +
                 `Number of IV attempts` + `Needle gauge`, data = data_subset)
summary(lm_model_without_interactions)

lm_model_with_interactions <- lm(`FPS-R score` ~ Age + Sex + Practitioner + `Number of IV attempts`
                + `Needle gauge` + Sex * Age + Sex * `Needle gauge` + Sex * Practitioner
                + Age * `Needle gauge` + Age * Practitioner + `Number of IV attempts` * Practitioner, 
                data = data_subset)
summary(lm_model_with_interactions)
```

# Print linear model without interactions

```{r}
plot(lm_model_without_interactions)
```

# Print linear model with interactions

```{r}
plot(lm_model_with_interactions)
```

## Objective 3

# Pie chart draw function with percentages

```{r}
draw_pie_chart <- function(all_categories, title) {
  # Count the occurrences of each category
  category_counts <- table(all_categories)

  # Calculate the percentage for each category
  percentages <- round(category_counts / sum(category_counts) * 100, 1)

  # Create labels that include both the category name and the percentage
  labels <- paste(names(category_counts), " - ", percentages, "%", sep="")

  # Create a pie chart with percentages
  pie(category_counts,
      main = title,
      col = rainbow(length(category_counts)),
      labels = labels,
      cex = 0.8)
}
```

# Pie chart for Observed side effects (No / Yes - Ametop alone / Yes - Ametop + vapocoolant spray)

```{r}
# Summarize "Any side effects observed?" column
side_effects_observed_summary <- data.frame(
  ifelse(original_data$`Any side effects observed?` == "No", "No Side Effect",
         ifelse(original_data$Randomization == 1, "Side Effect (Ametop alone)",
                "Side Effect (Ametop + vapocoolant spray)"))
)

# Create a pie chart for the observed side effects
draw_pie_chart(side_effects_observed_summary, "Observed Side Effects")
```

# Define the categorization function

```{r}
categorize_effects <- function(effect) {
  effect_lower <- tolower(effect)
  categories <- list(
    Redness = "red|redness|pink",
    Itching = "itchy|pruritic|pruritis",
    Pain = "pain|painful",
    Puffiness = "puffy"
  )

  identified_categories <- character(0)

  # Negation patterns
  pattern_start <- "\\b(no|not)\\s+("
  pattern_middle <- ")\\b|(no|not)\\s+\\w+\\s+or\\s+("
  pattern_end <- ")"

  for (category_name in names(categories)) {
    symptom_pattern <- categories[[category_name]]

    # Check for the symptom but exclude if negated
    if (grepl(symptom_pattern, effect_lower)) {
      negation_pattern <- paste0(
        pattern_start, symptom_pattern, pattern_middle, symptom_pattern, pattern_end)
      if (!grepl(negation_pattern, effect_lower)) {
        identified_categories <- c(identified_categories, category_name)
      }
    }
  }

  # Return "Other" if no category is found
  if (length(identified_categories) == 0) {
    return("Other")
  }

  return(identified_categories)
}
```

# Categorization function caller

```{r}
# Apply the categorization function and create a list of categories for each side effect
categorize_and_print <- function(group_number) {
  side_effects_data <- data.frame(SideEffects = na.omit(original_data[
    original_data$Randomization == group_number,]$`Observed side effects`))
  side_effects_data$Categories <- sapply(side_effects_data$SideEffects,
                                          categorize_effects, USE.NAMES=FALSE)
  print(data.frame(side_effects_data$SideEffects,
                   sapply(side_effects_data$Categories, paste, collapse = ", ")))
  return(side_effects_data)
}
```

# Pie chart draw function for combined categories

```{r}
draw_pie_chart_combined <- function(side_effects_data, title) {
  # Combination Categories
  all_categories <- sapply(side_effects_data$Categories, paste, collapse = " + ")

  # Use the draw_pie_chart function to create the pie chart
  draw_pie_chart(all_categories, title)
}
```

# Pie chart draw function for individual categories

```{r}
draw_pie_chart_individual <- function(side_effects_data, title) {
  # Flatten the list into a vector
  all_categories <- unlist(side_effects_data$Categories)

  # Use the draw_pie_chart function to create the pie chart
  draw_pie_chart(all_categories, title)
}
```

# Pie chart for observed side effects of Ametop alone (Redness, Itching, Pain, Puffiness)

```{r}
# Get the side effects data for the control group
side_effects_data_control_group <- categorize_and_print(1)

# Pie Chart for combined categories
draw_pie_chart_combined(side_effects_data_control_group,
                        "Combination Side Effects Distribution - Ametop alone")

# Pie Chart for individual categories
draw_pie_chart_individual(side_effects_data_control_group,
                          "Individual Side Effects Distribution - Ametop alone")
```

# Pie chart for observed side effects of Ametop + Spray (Redness, Itching, Pain, Puffiness)

```{r}
# Get the side effects data for the study group
side_effects_data_study_group <- categorize_and_print(2)

# Pie Chart for combined categories
draw_pie_chart_combined(side_effects_data_study_group,
                        "Combination Side Effects Distribution - Ametop + Spray")

# Pie Chart for individual categories
draw_pie_chart_individual(side_effects_data_study_group,
                          "Individual Side Effects Distribution - Ametop + Spray")
```